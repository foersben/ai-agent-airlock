#!/bin/bash
set -e

BUILD_DIR="$HOME/.config/containers/antigravity_build"
REPO_DIR="$BUILD_DIR/antigravity-bin"

echo "üöÄ Starting Antigravity Update..."
echo "‚ö†Ô∏è  WARNING: This will delete the current container."
echo "    Any packages installed via 'sudo pacman' inside the container will be lost."
echo "    (Project files in ~/Documents/ai_sandbox are SAFE)"
echo "    (Pip/Npm caches are SAFE)"

read -p "Continue? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
	echo "Aborted."
	exit 1
fi

# 1. Update the AUR Package Definition
if [ -d "$REPO_DIR" ]; then
	echo "üì• Pulling latest changes from AUR..."
	cd "$REPO_DIR"
	git pull
else
	echo "‚ö†Ô∏è  AUR directory not found. Cloning fresh..."
	cd "$BUILD_DIR"
	git clone https://aur.archlinux.org/antigravity-bin.git
fi

# 2. Rebuild the Image
echo "üèóÔ∏è  Rebuilding Container Image..."
cd "$BUILD_DIR"
podman build --no-cache -t antigravity_image .

# 3. Remove the Old Container
echo "‚ôªÔ∏è  Removing old container instance..."
podman rm -f antigravity_box || true

echo "‚úÖ Update Complete!"
echo "Run 'antigravity' to launch."
