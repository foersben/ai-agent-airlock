#!/bin/bash

# --- Configuration ---
CONTAINER_NAME="antigravity_box"
IMAGE_NAME="antigravity_image"
PROJECT_DIR="$HOME/Documents/ai_sandbox"

# --- Display & GPU Logic ---
DISPLAY_MOUNTS=""
# OLD (Software / Slow / Buggy):
# GPU_FLAGS="--disable-gpu --use-gl=swiftshader"

# NEW (Hardware / Fast):
GPU_FLAGS="--device /dev/dri"

if [ -n "$WAYLAND_DISPLAY" ]; then
    if [ -e "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY" ]; then
        DISPLAY_MOUNTS="--volume $XDG_RUNTIME_DIR/$WAYLAND_DISPLAY:/run/user/1000/$WAYLAND_DISPLAY --env WAYLAND_DISPLAY=$WAYLAND_DISPLAY --env XDG_RUNTIME_DIR=/run/user/1000"
    fi
fi

if [ -n "$DISPLAY" ]; then
    xhost +si:localuser:$(whoami) > /dev/null
    DISPLAY_MOUNTS="$DISPLAY_MOUNTS --volume /tmp/.X11-unix:/tmp/.X11-unix:ro --env DISPLAY=$DISPLAY"
fi

# --- Pre-Flight Checks ---
if podman ps --format "{{.Names}}" | grep -q "^$CONTAINER_NAME$"; then
    echo "Focusing running instance..."
    if command -v wmctrl &> /dev/null; then wmctrl -a "Antigravity"; fi
    exit 0
fi

if podman ps -a --format "{{.Names}}" | grep -q "^$CONTAINER_NAME$"; then
    echo "Reviving stopped instance..."
    podman start "$CONTAINER_NAME"
    exit 0
fi

# --- Optional Mounts ---
SOCK_MOUNT=""
if [ -n "$SSH_AUTH_SOCK" ]; then
    SOCK_MOUNT="--volume $SSH_AUTH_SOCK:/run/host-services/ssh-auth.sock --env SSH_AUTH_SOCK=/run/host-services/ssh-auth.sock"
fi

DBUS_MOUNT=""
if [ -e "/run/user/$(id -u)/bus" ]; then
    DBUS_MOUNT="--volume /run/user/$(id -u)/bus:/tmp/dbus-session-socket --env DBUS_SESSION_BUS_ADDRESS=unix:path=/tmp/dbus-session-socket"
fi

# --- Persistence Mounts ---
# We persist pip/npm/pacman caches so re-installing things is fast
CACHE_MOUNTS=" \
    --volume antigravity_config:/home/pilot/.config/Antigravity \
    --volume antigravity_extensions:/home/pilot/.antigravity/extensions \
    --volume antigravity_userdata:/home/pilot/.antigravity \
    --volume antigravity_pip_cache:/home/pilot/.cache/pip \
    --volume antigravity_npm_cache:/home/pilot/.npm \
    --volume antigravity_pacman_cache:/var/cache/pacman/pkg"

# --- Dotfiles & Flexibility ---
DOTFILES_HOST_DIR="$HOME/.config/containers/antigravity_dotfiles"
DOTFILES_MOUNTS=""
BOOT_SCRIPT=""

if [ -d "$DOTFILES_HOST_DIR" ]; then
    echo "ðŸŽ¨ Loading custom dotfiles..."
    
    # 1. ZSH (from dotfiles/zsh/.zshrc)
    if [ -f "$DOTFILES_HOST_DIR/zsh/.zshrc" ]; then
        DOTFILES_MOUNTS="$DOTFILES_MOUNTS --volume $DOTFILES_HOST_DIR/zsh/.zshrc:/home/pilot/.zshrc:ro"
    fi

    # 2. TMUX (from dotfiles/tmux/.tmux.conf)
    if [ -f "$DOTFILES_HOST_DIR/tmux/.tmux.conf" ]; then
        DOTFILES_MOUNTS="$DOTFILES_MOUNTS --volume $DOTFILES_HOST_DIR/tmux/.tmux.conf:/home/pilot/.tmux.conf:ro"
    fi

    # 3. FISH (from dotfiles/fish/.config/fish/config.fish)
    # Checking both flat and nested structure to be safe
    if [ -f "$DOTFILES_HOST_DIR/fish/.config/fish/config.fish" ]; then
        DOTFILES_MOUNTS="$DOTFILES_MOUNTS --volume $DOTFILES_HOST_DIR/fish/.config/fish/config.fish:/home/pilot/.config/fish/config.fish:ro"
    elif [ -f "$DOTFILES_HOST_DIR/fish/config.fish" ]; then
        DOTFILES_MOUNTS="$DOTFILES_MOUNTS --volume $DOTFILES_HOST_DIR/fish/config.fish:/home/pilot/.config/fish/config.fish:ro"
    fi

    # 4. STARSHIP
    if [ -f "$DOTFILES_HOST_DIR/starship/.config/starship.toml" ]; then
        DOTFILES_MOUNTS="$DOTFILES_MOUNTS --volume $DOTFILES_HOST_DIR/starship/.config/starship.toml:/home/pilot/.config/starship.toml:ro"
    fi
    
    # 5. BOOT SCRIPT (Flexibility Hook)
    # If boot.sh exists, we mount it and tell the container to run it
    if [ -f "$DOTFILES_HOST_DIR/boot.sh" ]; then
        echo "ðŸ”§ Found boot.sh - Custom startup logic enabled."
        chmod +x "$DOTFILES_HOST_DIR/boot.sh"
        DOTFILES_MOUNTS="$DOTFILES_MOUNTS --volume $DOTFILES_HOST_DIR/boot.sh:/home/pilot/.boot.sh:ro"
        # We append a command to execute this script in the background or before the app
        # Since we can't easily change the ENTRYPOINT, we rely on the user running it or using .zshrc to trigger it.
        # BETTER OPTION: We mount it to a profile.d script or zshrc sourcing?
        # Simplest: We inject it into .zshrc via a separate mount if we want it auto-run, 
        # OR we just accept that the user must run `./.boot.sh` manually.
        # AUTOMATED APPROACH: Mount it to /etc/profile.d/99-custom-boot.sh (requires root, which we have at build time, but not run time).
        # SAFE APPROACH: Mount to /home/pilot/.boot.sh and add a trigger to .zshrc
    fi
fi

# --- Launch ---
# We use --entrypoint to allow running a setup command if needed, but standard `antigravity` is fine.
podman run -d \
    --name "$CONTAINER_NAME" \
    --userns=keep-id \
    --net=slirp4netns \
    --dns 8.8.8.8 \
    --ipc=host \
    --env LIBGL_ALWAYS_SOFTWARE=1 \
    --env ELECTRON_DISABLE_GPU=1 \
    -p 3000-3005:3000-3005 \
    -p 4000-4005:4000-4005 \
    -p 5000-5005:5000-5005 \
    -p 8000-8005:8000-8005 \
    -p 8080-8085:8080-8085 \
    --volume "$PROJECT_DIR":/home/pilot/projects \
    --device /dev/snd \
    $DISPLAY_MOUNTS \
    $SOCK_MOUNT \
    $DBUS_MOUNT \
    $DOTFILES_MOUNTS \
    $CACHE_MOUNTS \
    "$IMAGE_NAME" \
    antigravity \
    --no-sandbox \
    --password-store="basic" \
    $GPU_FLAGS \
	--disable-dev-shm-usage \
	--wait /home/pilot/projects
